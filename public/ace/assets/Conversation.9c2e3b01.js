import{I as F}from"./vendor-others.11f5dab8.js";import{L as P}from"./Chatdoc.ca12b9eb.js";import{Y as H,Z as N,l as D,_ as E,x as R,F as b,H as K,$ as S}from"./index.5f82e941.js";import{a as z}from"./vendor-axios.938e43d7.js";import{M as G,E as q,a as T,b as W,c as Q,d as J,e as Y,f as j,g as A,A as Z,h as X}from"./Status.a3113516.js";import{i as x}from"./is.dd611415.js";import{a2 as V}from"./vendor-fortawesome.8c26b529.js";import{I as M,s as ee,u as se,e as te}from"./vendor-element-plus.4011bc9f.js";import{d as k,ak as l,o,e as c,H as h,f as i,R as m,P as w,Q as v,ah as B,K as O,aq as U,M as f,a3 as I,I as L,O as oe}from"./vendor-@vue.e467cd49.js";import{C as ie}from"./CopyToClipboard.27b2f89b.js";import"./vendor-highlight.js.5674318b.js";import"./vendor-qrcode.f15bf907.js";import"./application.ea1e2a72.js";import"./vendor-markdown.2cd127bb.js";var $=(e=>(e.PENDING="pending",e.ANSWERING="answering",e.FINISHED="finished",e.FAILED="failed",e))($||{});const ne=k({name:"SidePanel",components:{ElInput:M,FontAwesomeIcon:V,ElSkeleton:ee},props:{},emits:["click"],computed:{repositoryId(){var e,t;return(t=(e=this.$route.params)==null?void 0:e.repositoryId)==null?void 0:t.toString()},conversationId(){var e,t;return(t=(e=this.$route.params)==null?void 0:e.conversationId)==null?void 0:t.toString()},repository(){var e,t,n;return(n=(t=(e=this.$store.state)==null?void 0:e.chatdoc)==null?void 0:t.repositories)==null?void 0:n.find(d=>d.id===this.repositoryId)},conversations(){var e;return(e=this.repository)==null?void 0:e.conversations},application(){return this.$store.state.chatdoc.application}},methods:{async onNewConversation(){this.$router.push({name:H,params:{repositoryId:this.repositoryId}})},async onConfirm(e){e!=null&&e.deleting?(await N.deleteConversation(e.id),await this.$store.dispatch("chat/getConversations")):e!=null&&e.editing?(await N.updateConversation(e),await this.$store.dispatch("chat/getConversations")):e.editing=!0},onClick(e){!e||(this.$router.push({name:D,params:{repositoryId:this.repositoryId,conversationId:e}}),this.$emit("click",e))}}}),ae={class:"panel"},re={key:1,class:"conversations"},le={class:"icons"},de={class:"title"},ce=["onClick"],pe={class:"icons"},ue={class:"title"},he={key:0},me={key:1},_e={key:2},ge={class:"operations"};function fe(e,t,n,d,r,y){const p=l("el-skeleton"),a=l("font-awesome-icon"),_=l("el-input");return o(),c("div",ae,[e.conversations===void 0?(o(),h(p,{key:0})):(o(),c("div",re,[i("div",{class:"conversation",onClick:t[0]||(t[0]=(...s)=>e.onNewConversation&&e.onNewConversation(...s))},[i("div",le,[m(a,{icon:"fa-solid fa-plus",class:"icon"})]),i("div",de,w(e.$t("chatdoc.message.startNewChat")),1)]),(o(!0),c(v,null,B(e.conversations,(s,C)=>{var u;return o(),c("div",{key:C,class:O({conversation:!0,active:s.id===e.conversationId}),onClick:g=>e.onClick(s.id)},[i("div",pe,[m(a,{icon:"fa-regular fa-comment",class:"icon"})]),i("div",ue,[s!=null&&s.deleting?(o(),c("span",he,w(`${e.$t("chatdoc.message.confirmDelete")}?`),1)):s!=null&&s.editing?(o(),c("span",me,[m(_,{modelValue:s.title,"onUpdate:modelValue":g=>s.title=g,onKeydown:U(g=>e.onConfirm(s),["enter"])},null,8,["modelValue","onUpdate:modelValue","onKeydown"])])):(s==null?void 0:s.title)||(s==null?void 0:s.messages)?(o(),c("span",_e,w((s==null?void 0:s.title)||((u=s==null?void 0:s.messages[(s==null?void 0:s.messages.length)-1])==null?void 0:u.content)),1)):f("v-if",!0)]),i("div",ge,[!(s!=null&&s.editing)&&!s.deleting?(o(),h(a,{key:0,icon:"fa-solid fa-edit",class:"icon icon-edit",onClick:I(g=>s.editing=!0,["stop"])},null,8,["onClick"])):f("v-if",!0),!(s!=null&&s.editing)&&!s.deleting?(o(),h(a,{key:1,icon:"fa-solid fa-trash",class:"icon icon-delete",onClick:I(g=>s.deleting=!0,["stop"])},null,8,["onClick"])):f("v-if",!0),(s==null?void 0:s.editing)||s.deleting?(o(),h(a,{key:2,icon:"fa-solid fa-check",class:"icon icon-confirm",onClick:I(g=>e.onConfirm(s),["stop"])},null,8,["onClick"])):f("v-if",!0),(s==null?void 0:s.editing)||s.deleting?(o(),h(a,{key:3,icon:"fa-solid fa-xmark",class:"icon icon-cancel",onClick:I(g=>{s.editing=!1,s.deleting=!1},["stop"])},null,8,["onClick"])):f("v-if",!0)])],10,ce)}),128))]))])}var ye=E(ne,[["render",fe],["__scopeId","data-v-2282a6e1"],["__file","D:/react/Nexior/src/components/chatdoc/Conversations.vue"]]);const $e=k({name:"AnsweringMark",data(){return{}},computed:{conversationId(){var e,t;return(t=(e=this.$route.params)==null?void 0:e.conversationId)==null?void 0:t.toString()}}}),Ce={class:"box"};function Ie(e,t,n,d,r,y){return o(),c("div",Ce)}var we=E($e,[["render",Ie],["__file","D:/react/Nexior/src/components/chatdoc/AnsweringMark.vue"]]);const Ee=k({name:"Message",components:{CopyToClipboard:ie,AnsweringMark:we,MarkdownRenderer:G,ElAlert:se,ElButton:te},props:{message:{type:Object,required:!0}},emits:["stop"],data(){return{copied:!1,messageState:$}},computed:{errorText(){var e,t;if(!(!this.message.error||!((e=this.message.error)!=null&&e.code)))switch((t=this.message.error)==null?void 0:t.code){case A:return this.$t("chatdoc.message.errorUsedUp");case j:return this.$t("chatdoc.message.errorApiError");case Y:return this.$t("chatdoc.message.errorBadRequest");case J:return this.$t("chatdoc.message.errorTimeout");case Q:return this.$t("chatdoc.message.errorTooManyRequests");case W:return this.$t("chatdoc.message.errorContentTooLarge");case T:return this.$t("chatdoc.message.errorNotApplied");case q:default:return this.$t("chatdoc.message.errorUnknown")}},showBuyMore(){var e;return this.message.role===R&&((e=this.message.error)==null?void 0:e.code)===A}},methods:{onCopy(){F(this.message.content.toString(),{debug:!0}),this.copied=!0,setTimeout(()=>{this.copied=!1},3e3)},onBuyMore(){}}}),ke=["role"],Re={class:"content"},ve={class:"operations"};function Se(e,t,n,d,r,y){var u;const p=l("markdown-renderer"),a=l("answering-mark"),_=l("copy-to-clipboard"),s=l("el-alert"),C=l("el-button");return o(),c(v,null,[i("div",{class:O({message:!0,[e.message.role]:!0,hidden:e.errorText&&e.message.role==="assistant"}),role:e.message.role},[i("div",Re,[m(p,{content:(u=e.message)==null?void 0:u.content},null,8,["content"]),e.message.state===e.messageState.PENDING?(o(),h(a,{key:0})):f("v-if",!0)]),i("div",ve,[m(_,{content:e.message.content,class:"btn-copy"},null,8,["content"])])],10,ke),e.errorText?(o(),h(s,{key:0,class:"error",title:e.errorText,type:"error",closable:!1},null,8,["title"])):f("v-if",!0),e.showBuyMore?(o(),h(C,{key:1,round:"",type:"primary",class:"btn btn-buy",size:"small",onClick:e.onBuyMore},{default:L(()=>[oe(w(e.$t("common.button.buyMore")),1)]),_:1},8,["onClick"])):f("v-if",!0)],64)}var Ne=E(Ee,[["render",Se],["__scopeId","data-v-95a62450"],["__file","D:/react/Nexior/src/components/chatdoc/Message.vue"]]);const Oe=k({name:"InputBox",components:{ElInput:M,FontAwesomeIcon:V},props:{disabled:{type:Boolean,required:!1,default:!1},question:{type:String,required:!0}},emits:["update:question","submit"],data(){return{questionValue:this.question,fileList:[]}},computed:{model(){return this.$store.state.chat.model}},watch:{questionValue(e){this.$emit("update:question",e)},question(e){e!==this.questionValue&&(this.questionValue=e)},references(e){e.length===0&&(this.fileList=[])}},methods:{onSubmit(){!this.question||this.$emit("submit")}}}),be={class:"input-box"},Ae={class:"info"};function De(e,t,n,d,r,y){const p=l("font-awesome-icon"),a=l("el-input");return o(),c(v,null,[i("div",be,[i("span",{class:O({btn:!0,"btn-send":!0,disabled:!e.question}),onClick:t[0]||(t[0]=(..._)=>e.onSubmit&&e.onSubmit(..._))},[m(p,{icon:"fa-solid fa-location-arrow",class:"icon icon-send"})],2),m(a,{modelValue:e.questionValue,"onUpdate:modelValue":t[1]||(t[1]=_=>e.questionValue=_),disabled:e.disabled,class:"input",type:"textarea",placeholder:e.$t("chat.message.newMessagePlaceholder"),onKeydown:U(I(e.onSubmit,["exact","prevent"]),["enter"])},null,8,["modelValue","disabled","placeholder","onKeydown"])]),i("p",Ae,w(e.$t("chat.message.howToUse")),1)],64)}var qe=E(Oe,[["render",De],["__scopeId","data-v-7ed35c20"],["__file","D:/react/Nexior/src/components/chatdoc/InputBox.vue"]]);const Te=k({name:"ChatdocConversation",components:{Layout:P,Conversations:ye,Message:Ne,InputBox:qe,ApplicationStatus:Z},data(){return{loading:!1,repositoryId:this.$route.params.repositoryId.toString(),answering:!1,question:""}},computed:{messages:{get(){var e,t;return((t=(e=this.conversations)==null?void 0:e.find(n=>{var d;return n.id===((d=this.$route.params.conversationId)==null?void 0:d.toString())}))==null?void 0:t.messages)||[]},set(e){console.log("set messages",e)}},repository(){var e,t,n;return(n=(t=(e=this.$store.state)==null?void 0:e.chatdoc)==null?void 0:t.repositories)==null?void 0:n.find(d=>d.id===this.repositoryId)},conversations(){var e;return(e=this.repository)==null?void 0:e.conversations},conversationId(){var e;return(e=this.$route.params.conversationId)==null?void 0:e.toString()},application(){return this.$store.state.chatdoc.application},credential(){return this.$store.state.chatdoc.credential},needApply(){return this.$store.state.chatdoc.status.getApplication===b.Success&&!this.application},initializing(){return this.$store.state.chatdoc.status.getApplication===b.Request},service(){return this.$store.state.chatdoc.service}},async mounted(){console.log("start get conversations"),this.loading=!0,this.$store.dispatch("chatdoc/getConversations",{repositoryId:this.repositoryId}).finally(()=>{this.loading=!1})},methods:{async onSubmit(){this.messages.push({content:this.question,role:K}),await this.onFetchAnswer()},async onScrollDown(){setTimeout(()=>{const e=document.querySelector(".dialogue");!e||!this.messages||this.messages.length===0||(e.scrollTop=e==null?void 0:e.scrollHeight)},0)},async onFetchAnswer(){var d;const e=(d=this.credential)==null?void 0:d.token,t=this.question;if(S(this.onFetchAnswer,"validated",t),this.question="",!e||!t){console.error("no token or endpoint or question"),this.messages.push({error:{code:T},role:R,state:$.FAILED});return}let n=this.conversationId;this.messages.push({content:"",role:R,state:$.PENDING}),S(this.onFetchAnswer,"start to get answer",this.messages),this.onScrollDown(),this.answering=!0,N.chatConversation({repositoryId:this.repositoryId,question:t,id:this.conversationId},{token:e,stream:r=>{this.messages[this.messages.length-1]={role:R,content:r.answer,state:$.ANSWERING},n=r.id,this.onScrollDown()}}).then(async()=>{S(this.onFetchAnswer,"finished fetch answer"),this.messages[this.messages.length-1].state=$.FINISHED,await this.$store.dispatch("chatdoc/setConversation",{id:n,messages:this.messages,repositoryId:this.repositoryId}),this.answering=!1,this.conversationId||(console.log("push to conversation",n),await this.$router.push({name:D,params:{conversationId:n,repositoryId:this.repositoryId}})),this.onScrollDown(),await this.$store.dispatch("chatdoc/getConversations",{repositoryId:this.repositoryId})}).catch(r=>{var y,p;if(this.messages&&this.messages.length>0&&(this.messages[this.messages.length-1].state=$.FAILED),console.error(r),z.isCancel(r))this.messages[this.messages.length-1].error={code:X};else if((y=r==null?void 0:r.response)!=null&&y.data){let a=(p=r==null?void 0:r.response)==null?void 0:p.data;x(a)&&(a=JSON.parse(a)),this.messages&&this.messages.length>0&&(this.messages[this.messages.length-1].error=a.error)}else this.messages&&this.messages.length>0&&(this.messages[this.messages.length-1].error={code:q});this.answering=!1})}}}),Ve={class:"wrapper"},Me={class:"chat"},Be={class:"status"},Ue={class:"dialogue"},Le={class:"messages"},Fe={class:"bottom"};function Pe(e,t,n,d,r,y){const p=l("conversations"),a=l("application-status"),_=l("message"),s=l("input-box"),C=l("layout");return o(),h(C,null,{chatdoc:L(()=>[i("div",Ve,[m(p,{class:"side"}),i("div",Me,[i("div",Be,[m(a,{"show-price":!1,initializing:e.initializing,application:e.application,"need-apply":e.needApply,service:e.service,onRefresh:t[0]||(t[0]=u=>e.$store.dispatch("chatdoc/getApplication"))},null,8,["initializing","application","need-apply","service"])]),i("div",Ue,[i("div",Le,[(o(!0),c(v,null,B(e.messages,(u,g)=>(o(),h(_,{key:g,message:u,class:"message"},null,8,["message"]))),128))])]),i("div",Fe,[m(s,{disabled:e.answering,question:e.question,"onUpdate:question":t[1]||(t[1]=u=>e.question=u),onSubmit:e.onSubmit},null,8,["disabled","question","onSubmit"])])])])]),_:1})}var ts=E(Te,[["render",Pe],["__scopeId","data-v-24089614"],["__file","D:/react/Nexior/src/pages/chatdoc/Conversation.vue"]]);export{ts as default};
